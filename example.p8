pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

local __tif__="7:4:2:2,7:10:2:131,4:12:4:130,11:4:4:65"

-- Converts __tif__ into a table for use with the tget, tgets and tset functions
local _tif,_tiftiles={},split(__tif__)
for tile in all(_tiftiles) do
    local x,y,s,f=unpack(split(tile,":"))
    if not _tif[x] then _tif[x]={} end
    _tif[x][y]={s,f}
end

-- Gets the value of a flag of a tile
function tget(x,y,f)
    return f==nil and _tif[x][y][2] or _tif[x][y][2]&1<<f>0
end

-- Gets the sprite for a tile
function tgets(x,y)
    return _tif[x][y][1]
end

-- Sets the value of a flag of a tile
function tset(x,y,f,v)
    local _f=_tif[x][y][2]
    _f=v==nil and f or v and _f|1<<f or _f&~(1<<f)
    _tif[x][y][2]=_f
end

-- Will contain all our entities
entities={}

-- Make a pink thing, using flags to set attributes
function make_pink(x,y,flags)
    add(
        entities,
        {
            x=x*8,
            y=y*8,
            sprite=2,
            -- Use flags 0, 1 and 2 to set the speed
            speed=flags&0b111,
            -- If flag 7 is set then face right, otherwise face left
            dir=tget(x,y,7) and 1 or -1,
            update=function(self, t)
                if t%4==0 then
                    self.sprite=self.sprite==3 and 2 or 3
                end
                local dx=self.speed*self.dir
                local o=self.dir==1 and 7 or 0
                local tx=(self.x+o+dx)\8
                if fget(mget(tx,self.y\8),0) then
                    dx=0
                    self.x=tx*8+(self.dir*-8)
                    self.dir*=-1
                end
                self.x+=dx
            end,
            draw=function(self)
                spr(self.sprite,self.x,self.y,1,1,self.dir==1)
            end
        }
    )
end

-- Make a green thing, using flags to set attributes
function make_green(x,y,flags)
    add(
        entities,
        {
            x=x*8,
            y=y*8,
            sprite=2,
            -- Use flags 0, 1 and 2 to set the speed
            speed=flags&0b111,
            -- If flag 7 is set then face down, otherwise face up
            dir=tget(x,y,7) and 1 or -1,
            -- If flag 6 is set then play sfx
            sfx=tget(x,y,6),
            update=function(self, t)
                if t%4==0 then
                    self.sprite=self.sprite==5 and 4 or 5
                end
                local dy=self.speed*self.dir
                local o=self.dir==1 and 7 or 0
                local ty=(self.y+o+dy)\8
                if fget(mget(self.x\8,ty),0) then
                    dy=0
                    self.y=ty*8+(self.dir*-8)
                    self.dir*=-1
                    if self.sfx then sfx(0) end
                end
                self.y+=dy
            end,
            draw=function(self)
                spr(self.sprite,self.x,self.y,1,1,self.dir==1)
            end
        }
    )
end

-- Sets the maker function to use for any Object Layer sprite placeholders
local makers={
    [2]=make_pink,
    [4]=make_green
}

local t=0

function _init()
    -- Loop through our Object Layer tiles
    -- and pass the co-ordinates and flags to the relevant maker function
    for tile in all(_tiftiles) do
        local x,y,sprite,flags=unpack(split(tile,":"))
        makers[sprite](x,y,flags)
    end
end

function _update60()
    t+=1
    for entity in all(entities) do
        entity:update(t)
    end
end

function _draw()
    cls()
    map()
    for entity in all(entities) do
        entity:draw()
    end
end


__gfx__
00000000111111110888888000000000033333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111117777788808888880777773330333333000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111117070788877777888707073337777733300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111117070788870707888707073337070733300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111117777788870707888777773337070733300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110888888877777888033333337777733300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110888888808888888033333330333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110088888000888880003333300033333000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100001705017050170500000000000290502905029050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
