pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

-- 67
-- 83
-- ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏èüÖæÔ∏è‚ùé

-- set palette
poke(0x5f2e,1)
pal({[0]=0,1,2,-13,4,5,6,7,8,9,10,11,-6,13,-7,0},1)

function mrnd(x,f)
    if f==nil then f=true end
    local r=x[1]+rnd((f and 1 or 0)+x[2]-x[1])
    return f and flr(r) or r
end

function range(n,m)
    return mrnd({n,m})
end

function round(n)
    return flr(n+0.5)
end

function manhattan(x1,y1,x2,y2)
    return abs(x1-x2)+abs(y1-y2)
end

function lerp(v0,v1,t)
    return v0+t*(v1-v0)
end

-- sets the volume for a range of notes in the given sfx
function set_volumes(sfxid, start, values)
    local address=0x3200+68*sfxid+start*2
    for _,value in ipairs(values) do
        local bytes=%address&0xf1ff
        bytes=bytes|value<<9
        poke2(address,bytes)
        address+=2
    end
end

class=setmetatable(
    {
        new=function(_ENV,tbl)
            return setmetatable(tbl or {},{__index=_ENV})
        end
    },
    {__index=_ENV}
)

entity=class:new({
    tile=function(p)
        return p\8
    end
})

button=entity:new({
    reset=function(_ENV)
        s=1
        beam=1
    end,
    update=function(_ENV)
        if s==2 then return end
        if (x+dx1<=p.x+7) and
            (p.x<x+4) and
            (y+1<=p.y2+5) and
            (p.y1<y+6) then
            dx1=dx1==0 and 0 or 7
            dx2=dx1==0 and 0 or 7
            s=2
            printh(p.x..' HIT')
            -- sfx(6)
            entities[beam].s=2
-- (x+hitbox.x<=object.x+object.hitbox.x2) and
--    (object.x+object.hitbox.x<x+hitbox.w) and
--    (y+hitbox.y<=object.y+object.hitbox.y2) and
--    (object.y+object.hitbox.y<y+hitbox.h)

        end
    end,
    draw=function(_ENV)
        rectfill(x+dx1,y+1,x+dx2,y+6,10)
    end
})

beam=entity:new({
    reset=function(_ENV)
        x=tx*8
        y=ty1*8
        l=(ty2-ty1+1)*8
        o=false
        s=1
        t=0
    end,
    update=function(_ENV)
        if s==1 then
            local d=min(manhattan(x,y,p.x,p.y1),manhattan(x,y+l,p.x,p.y1))
            local max=200
            if d>max then
                if o then sfx(4,-2) o=false end
            else
                local v=round(mid(0,(max-d)/(max/7),7))
                -- printh(d..':'..v)
                set_volumes(4,0,{v,v,v})
                if not o then sfx(4) o=true end
            end
        elseif s==2 then
            -- sfx(4)
            s=3
        elseif s==3 then
            if t%4 then
                if o then
                    o=false
                    sfx(4)
                else
                    o=true
                    sfx(4,-2)
                end
            end
            t+=1
            if t>20 then s=4 sfx(5) end
        else
            sfx(4,-2)
            deli(entities,entity)
        end
    end,
    draw=function(_ENV)
        if s==4 then return end
        for i=1,12 do
            for dx=0,7 do
                pset(x+dx,y+rnd(l),(dx<3 or dx>4) and 1 or 11)
            end
        end
        if s>2 then
            if o then
                rectfill(x,y,x+7,y+l, 0)
                if t>18 then
                    for i=ty1,ty2 do mset(tx,i,0) end
                end
            end
        end
    end
})

frog=entity:new({
    reset=function(_ENV)
        t=0
        stage=0
        r=range(12,16)
        -- dead=false
    end,
    update=function(_ENV)
        if stage==0 then
            if manhattan(x,y,p.x,p.y2)<range(16,24) then
                stage=1
            else
                return
            end
        end
        local dx,dy,cx,cy,tx,ty,ti
        if stage==1 then
            dx=2*d
            dy=-1
            if t==7 then sfx(0) end
        else
            dx=stage==2 and d or 0
            dy=1
        end
        cx=x+(2*d)
        cy=y+(stage==1 and -2 or 2)
        tx=tile(cx+dx)
        ty=tile(cy+dy)
        ti=mget(tx,ty)
        if fget(ti,0) then
            ti=mget(tile(cx),ty)
            if fget(ti,0) then
                if stage==1 then
                    y=ty*8+8
                else
                    y=ty*8-1
                    cy=y
                    reset(_ENV)
                end
            end
            ti=mget(tx,tile(cy))
            if fget(ti,0) then
                if ti==63 then
                    sfx(3)
                    deli(entities,entity)
                    return
                end
                x=tx*8+(d==1 and -3 or 10)
                if stage==1 and t<6 then d=d==1 and -1 or 1 end
            end
            if stage>0 then stage=3 end
            dx=0
            dy=0
        end
        x+=dx
        y+=dy
        x=x%128 -- can remove
        if stage==1 then
            t+=1
            if t==r then stage=2 end
        end
    end,
    draw=function(_ENV)
        local ex=x+2*d
        local c=11
        if stage==0 then
            line(x,y,x+1,y,c)
            pset(x+(d==1 and 1 or 0),y-1,c)
        else
            line(x,y,ex,y+(stage==1 and -2 or 2),c)
        end
    end
})

player=entity:new({
    reset=function(_ENV)
        t=0
        s=0
        o1=1
        o2=0
        jc=0
        g=true
        f=1
        dx=0
        dy=0
        b=false
        dyc=0
        ct=0
    end,
    update=function(_ENV)
        local ti,hit
        if btn(‚û°Ô∏è) then dx+=0.5 f=1 end
        if btn(‚¨ÖÔ∏è) then dx-=0.5 f=-1 end

        if btn(‚ùé) or btn(üÖæÔ∏è) then
            local canjump=jc==0 and not b and g -- (g or ct>0)
            if canjump then
                jc=11
                y1=tile(y1)*8
                sfx(2)
            end
            b=true
        else
            jc=0
            b=false
        end

        if jc>0 then
            dy-=2
            jc-=1
            g=false
        end

        dy+=0.7 -- gravity
        dy=mid(-3,dy,3)
        local rdy=round(dy)

        dx*=g and 0.7 or 0.75
        dx=mid(-2,dx,2)
        local rdx=round(dx)

        -- checking vertical movement
        hit=false
        for tx in all({tile(x), tile(x+7)}) do
            if dy>0 then
                ty=tile(y2+7+rdy)
            else
                ty=tile(y1+rdy)
            end
            ti=mget(tx,ty)
            hit=fget(ti,0)
            if hit then break end
        end
        if hit then
            if dy>0 then
                y1=(ty-1)*8
                if g==false then
                    s=1
                    dyc=rdy
                    t=0
                    sfx(1)
                end
                g=true
                jc=0
                ct=0
            else
                y1=(ty+1)*8
            end
            y2=y1
            dy=0
            rdy=0
        end

        if g and dy>0 then ct=10 end
        if ct>0 then
            -- dy=0
            ct-=1
        end

        if dy!=0 then g=false o1=0 end

        -- checking horizontal movement
        hit=false
        for ty in all({tile(y1), tile(y1+3), tile(y2+7)}) do
            tx=tile(x+rdx+(dx>0 and 7 or 0))
            ti=mget(tx,ty)
            hit=fget(ti,0)
            if hit then break end
        end
        if hit then
            x=(tx+(dx>0 and -1 or 1))*8
            dx,rdx=0,0
            -- beam
            if ti==63 then
                sfx(3)
                -- assert(false)
            end
        end

        local adx=abs(dx)
        if adx<0.05 then dx=0 end

        if g then
            if dyc>0 then
                if t%2==0 then
                    dyc-=1
                    o1=mid(0,o1+1,2)
                    if dyc==0 then t=5 end
                end
            elseif rdx==0 then
                o1=1
                t=0
            elseif jc==0 then
                if t%5==0 then
                    if s==1 then
                        o1=1
                        s=0
                    else
                        o1=0
                        s=1
                    end
                end
            end
        else
            if dy>0 then -- have dyc counter that starts at 3 and counts down if falling
                -- o1=1
            else
                if jc>7 then o2=1 else o2=0 end
            end
        end

        if btn(‚¨áÔ∏è) and g then dy,o1=0,2 end

        x+=rdx
        x%=128

        -- i think i should really only be adding o1 and o2 when drawing
        -- as it stands the offset is changing the y value and accumulating the change
        -- i think it would make more sense and be more manageable if it didn't
        y1+=(dy+o1)
        y2+=(dy+o2)

        t+=1
    end,
    draw=function(_ENV)
        local flip=f==-1

        rectfill(x,y1+5,x+7,y2+4,12)
        spr(83,x,y2,1,1,flip) -- bottom
        spr(67,x,y1,1,1,flip) -- top

        -- color(1)
        -- print(jc,0,0)
        -- print(g,20,0)
        -- print(o1,60,0)
        -- print(o2,80,0)
        -- print(dx,0,10)
        -- print(dy,32,10)
        -- print(ct,0,20)
    end
})

p=player:new({
    x=24,
    y1=112,
    y2=112
})
p:reset()

-- f=frog:new({x=87,y=98,d=1})

endex=0
entities={}

-- sets direction according to flags 10000000 = l, 01000000 = r
makefrog=function(x,y,flags)
    local entity=frog:new({x=x*8+2,y=y*8+7,d=flags==2 and 1 or -1,entity=endex})
    printh('frog '..endex)
    entity:reset()
    add(entities,entity)
end

-- looks for a beam placeholder, finds the end and makes a beam entity
makebeam=function(x,y,flags)
    local y2=y
    repeat
        y2+=1
        ti=mget(x,y2)
    until ti==114
    for i=y,y2 do
        mset(x,i,63)
    end
    local entity=beam:new({tx=x,ty1=y,ty2=y2,entity=endex})
    printh('beam '..endex)
    entity:reset()
    add(entities,entity)
end

makebutton=function(x,y,flags)
    local entity=button:new({x=x*8,y=y*8,dx1=flags==2 and 0 or 4,dx2=flags==2 and 3 or 7})
    printh('button '..endex)
    entity:reset()
    add(entities,entity)
end

converters={
    [112]=makefrog,
    [113]=makefrog,
    [114]=makebeam,
    [115]=makebutton,
    [116]=makebutton,
}

for ty=0,255 do
    for tx=0,128 do
        local ti=mget(tx,ty)
        if ti>=112 then
            mset(tx,ty,0)
            endex+=1
            converters[ti](tx,ty,fget(ti))
            printh("endex "..endex)
        end
    end
end

for e in all(entities) do printh(e.entity) end

function _update60()
    p:update()
    -- f:update()

    for e in all(entities) do e:update() end
end

function _draw()
    cls()

    -- local buffer=20,cx,cy
    -- if p.x<64+buffer then cx=0 else cx=p.x-64-buffer end
    -- camera(cx,p.y1-64)

    map(0,0)

    for e in all(entities) do e:draw() end

    p:draw()
    -- f:draw()

    -- print(abs(p.x-f.x),0,100,7)
    -- print(f.stage,30,100,7)

    camera(0,0)
    color(5)
    -- print(flr(stat(2)*10000/100),0,0,7)
    print(stat(2),0,0)
    print(stat(7),35,0)
    print(stat(8),50,0)
    -- print(stat(9),60,10,7)
end

__gfx__
00000000777077707770777077777770777707777000000000000007700000000000000760000000000000060777777077707777000000000000000000000000
00000000707070707070707070000070700707077000000000000007700000000000000760000000000000060700007070707007000000000000000000000000
00000000700000000000000070000000000000077000000000000007700000000000000766000000000000660000007000000007000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000760000000000000060000000000000000000000000000000000000000
00000000700000000000000000000000000000077000000000000007700000000000000760600000000006060000000000000000000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000766000000000000660000000000000000000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000766000000000000660000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000060600000000006060000000000000000000000000000000000000000
00000000660000000000000000000000000000666600000060000000000000060000006600000000000000000000000000000000000000000000000000000000
00000000660000000000000000000000000000666000000066000000000000660000000600000000000000000000aaaaaaaa0000000000000000000000000000
00000000606000000000000000000000000006066600000066000000000000660000006600000000000000000000aaaaaaaa0000000000000000000000000000
00000000660060000000000000000000000000666600000060060000000060060000006600000000000000000000aaaaaaaa0000000000000000000000000000
00000000660600000000000000006000000060666060000066000000000000660000060600000000000000000000aaaaaaaa00000aaaaaa00000000000000000
00000000606006000006000006000000006006066600000066000000000000660000006600000000000000000000aaaaaaaa00000aaaaaa00000000000000000
00000000660660660660660660660660660660666600000060600000000006060000006600000066660000000000aaaaaaaa00000aaaaaa00000000000000000
000000006666666666666666666666666666666660000000660000000000006600000006000000666600000000000000000000000aaaaaa00000000000000000
03003030030030303003030000000000000000000000000000000000099999900000000000000000000000006000000000000006000000077000000000000000
03003030030030303000030000000000000000000000000000000000090000900000000000000000000000000000000000000000000000077000000000000000
03003030030030300000030000000000000000000000000000000000090000900000000000000000000000006000000000000006000000077000000000000000
03000300030030000000000000000000000000000000000000000000099999900000000000000000000000000000000000000000000000000000000000000000
03000000003030000000000000000000000000000000000000000000000090000000000000000000000000006000000000000006000000000000000000000000
00000000000300000000000000030000000800000000000000000000000990000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000003030030008080800000000000000000000090000000000000000006600000006300000000000036000000000000000000000000
00000000000000000000000033033033080808080000000000000000009990000000000000000066660000003300000000000033000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111003b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111f1f103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111f1f103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111103b77b30
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111003b77b30
0000000000000000000000000cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000ccccfcfc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000ccccfcfc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11bb11111111bb1113b77b31111aa11111aa11110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11bb11111111bb1113b77b3111aaa11111aaa1110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11bbbb1111bbbb1113b77b3111aaa11111aaa1110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11bbbb1111bbbb1113b77b31111aa11111aa11110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010101010101010100000000010101010101010101010000000000000000000000000000000000000101000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001020101020000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
00191212121212121212121212121a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0017212220210022007222002000150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0018000000000000003f00000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0017000000000000003f00000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0017740000000000003f00000000150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0018000000000000007200000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0017000071230000010400000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1314000001040073090a00000000111300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000090a0000111400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000011140000222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2300000020210000000000000000702300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0304000000000000000000002300010300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0006000000000000002324230103050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0008000000000000000103022e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0008740024242300730500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002d0b0202030302032e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000a5400d5400f54000200147000200002000010001c0001d0001d0000000006000185501b5501d550202002b1000000000000020000000000000000000000000000042000320003200032000320003200
000100000363008620026300561000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100000472009730127401a2001a2001a2001920017200172001720017200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100000f010176201203017630140301c640170501c6701b0001f600190001d0001e000246001e0001d0001d0001d0001d0001d0001d0001d0001d0001e0001e00014000140003460000000000000000000000
000100030005003050020500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
900100000455004550045500455004550045500355003550035500255002550015500155000550005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000006550003000a5500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
