pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

-- 67
-- 83
-- ⬅️➡️⬆️⬇️🅾️❎

function round(n)
    return flr(n+0.5)
end

class=setmetatable(
    {
        new=function(_ENV,tbl)
            return setmetatable(tbl or {},{__index=_ENV})
        end
    },
    {__index=_ENV}
)

entity=class:new({
    tile=function(p)
        return p\8
    end
})

player=entity:new({
    reset=function(_ENV)
        t=0
        s=0
        o1=1
        o2=0
        jc=0
        g=true
        f=1
        dx=0
        dy=0
        b=false
    end,
    update=function(_ENV)
        local ti,hit
        if btn(➡️) then dx+=0.5 f=1 end
        if btn(⬅️) then dx-=0.5 f=-1 end

        if btn(❎) or btn(🅾️) then
            if g and not b and jc==0 then
                jc=11
                o1=0
            end
            b=true
        else
            jc=0
            b=false
        end

        if jc>0 then
            dy-=2
            jc-=1
            g=false
        end

        dy+=0.7 -- gravity
        -- dy=mid(-3,round(dy),3)
        dy=mid(-3,dy,3)
        local rdy=round(dy)

        dx*=g and 0.7 or 0.75
        dx=mid(-2,dx,2)
        local rdx=round(dx)

        hit=false
        for tx in all({tile(x), tile(x+7)}) do
            if dy>0 then
                ty=tile(y2+7+rdy)
            else
                ty=tile(y1+rdy)
            end
            ti=mget(tx,ty)
            -- hit = hit or fget(ti,0)
            hit=fget(ti,0)
            if hit then break end
        end
        if hit then
            if dy>0 then
                y1=(ty-1)*8
                if g==false then s=1 end
                g=true
            else
                y1=(ty+1)*8
            end
            y2=y1
            printh('new y '..y1)
            dy=0
            rdy=0
        end

        if dy!=0 then g=false o1 = 0 end





        hit=false
        for ty in all({tile(y1), tile(y1+3), tile(y2+7)}) do
            tx=tile(x+rdx+(dx>0 and 7 or 0))
            ti=mget(tx,ty)
            -- hit = hit or fget(ti,0)
            hit=fget(ti,0)
            if hit then break end
        end
        if hit then
            if dx>0 then
                x=(tx-1)*8
            else
                x=(tx+1)*8
            end
            printh('new x '..x)
            dx=0
            rdx=0
            -- dy+=0.5
        end

        local adx=abs(dx)
        if adx<0.05 then dx=0 end

        -- g=dy==0

        if g then
            if rdx==0 then
                o1=1
                t=0
            else
                if t%5==0 then
                    if s==1 then
                        o1=1
                        s=0
                    else
                        o1=0
                        s=1
                    end
                end
            end
        else
            if dy>0 then -- have dyc counter that starts at 3 and counts down if falling
                o1=-1
            else
                if jc>8 then o2=-1 else o2 = 0 end
            end
        end

        x+=rdx
        x%=128

        y1+=(dy+o1)
        y2+=(dy+o2)

        -- y1+=dy
        -- y2+=dy

        t+=1
    end,
    draw=function(_ENV)
        local flip=f==-1


        -- if y2-y1>5 then
            rectfill(x,y1+5,x+7,y2+3,13)
        -- end

        spr(83,x,y2,1,1,flip) -- bottom

        spr(67,x,y1,1,1,flip) -- top


        print(jc,0,0)
        print(g,20,0)
        print(o1,60,0)
        print(o2,80,0)
        print(dx,0,10)
        print(dy,32,10)

    end
})

p=player:new({
    x=24,
    y1=112,
    y2=112
})
p:reset()

function _update60()
    p:update()
end

function _draw()
    cls()
    map(0,0)
    p:draw()
end

__gfx__
00000000777077707770777077777770777707777000000000000007700000000000000760000000000000060777777077707777000000000000000000000000
00000000707070707070707070000070700707077000000000000007700000000000000760000000000000060700007070707007000000000000000000000000
00000000700000000000000070000000000000077000000000000007700000000000000766000000000000660000007000000007000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000760000000000000060000000000000000000000000000000000000000
00000000700000000000000000000000000000077000000000000007700000000000000760600000000006060000000000000000000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000766000000000000660000000000000000000000000000000000000000
00000000700000000000000000000000000000070000000000000000700000000000000766000000000000660000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000060600000000006060000000000000000000000000000000000000000
00000000660000000000000000000000000000666600000060000000000000060000006600000000000000000000000000000000000000000000000000000000
00000000660000000000000000000000000000666000000066000000000000660000000600000000000000000000aaaaaaaa0000000000000000000000000000
00000000606000000000000000000000000006066600000066000000000000660000006600000000000000000000aaaaaaaa0000000000000000000000000000
00000000660060000000000000000000000000666600000060060000000060060000006600000000000000000000aaaaaaaa0000000000000000000000000b00
00000000660600000000000000006000000060666060000066000000000000660000060600000000000000000000aaaaaaaa00000aaaaaa0000000000000bbb0
00000000606006000006000006000000006006066600000066000000000000660000006600000000000000000000aaaaaaaa00000aaaaaa0000000b000bb00b0
00000000660660660660660660660660660660666600000060600000000006060000006600000066660000000000aaaaaaaa00000aaaaaa000000bb00b000000
000000006666666666666666666666666666666660000000660000000000006600000006000000666600000000000000000000000aaaaaa00000bbb000000000
010010100100101010010100000000006960669000000000000000900aaaaaa00000000000000000000000006000000000000006000000077000000000000000
010010100100101010000100000000000999999000000000099999900a0000a00000000000000000000000000000000000000000000000077000000000000000
010010100100101000000100000000000900000000000000090000000a0000a00000000000000000000000006000000000000006000000077000000000000000
010001000100100000000000000000000999999000000000099999900aaaaaa00000000000000000000000000000000000000000000000000000000000000000
010000000010100000000000000000000000009000000000000000900000a0000000000000000000000000006000000000000006000000000000000000000000
00000000000100000000000000030000099999900000000009999990000aa0000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000030300300900000009900990090000000000a0000000000000000006600000006100000000000016000000000000000000000000
0000000000000000000000003303303309999990090000900999999000aaa0000000000000000066660000001100000000000011000000000000000000000000
07777770000000000777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77777777000000007777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77771717000000007777171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77771717000000007777171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77777777000000007777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
77777777000000007777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
07777770000000000777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b77b30
0000000000000000000000000cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccc1c1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000007777770cccc1c1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000077777777cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2300000000000000000000000000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0304000000000000002300232300010300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0006000000000000000103020203050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0008230000232300230500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002d0b0202030302032e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
