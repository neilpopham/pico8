pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- testing pseudo 3d walls with flags
-- by neil popham

local tx=0 local ty=0

function round(x) return flr(x+0.5) end

function _init()
 p={x=24,y=24,dx=0,dy=0}
end

function _update60()
 -- p.dx=0 p.dy=0

 if btn(0) then p.dx=p.dx-0.2 end
 if btn(1) then p.dx=p.dx+0.2 end
 if btn(2) then p.dy=p.dy-0.2 end
 if btn(3) then p.dy=p.dy+0.2 end

 p.dx=mid(-3,p.dx*0.9,3)
 p.dy=mid(-3,p.dy*0.9,3)

 if p.dx~=0 then
  local x=p.x+round(p.dx)
  local dx=p.dx
  if p.dx>0 then x=x+7 end
  for _,cy in pairs({p.y,p.y+7}) do
   tx=flr(x/8)
   ty=flr(cy/8)
   tile=mget(tx,ty)
   if fget(tile,0) then
    if (p.y+p.dy+4)>(8*ty) then
     dx=0--(tx*8)-p.x+(p.dx<0 and 8 or -8)
    end
   end
   if fget(tile,1) then
    if (p.y+p.dy-4)<(8*ty) then
     dx=0--(tx*8)-p.x+(p.dx<0 and 8 or -8)
    end
   end
  end
  p.dx=dx
 end

 if abs(p.dx)<0.1 then p.dx=0 end
 if p.dx~=0 then
  printh("dx:"..p.dx)
  p.x=p.x+round(p.dx)
 end

 if p.dy~=0 then
  local y=p.y+round(p.dy)
  local dy=p.dy
  if p.dy>0 then y=y+7 end
  for _,cx in pairs({p.x,p.x+7}) do
   tx=flr(cx/8)
   ty=flr(y/8)
   tile=mget(tx,ty)
   if fget(tile,0) then
    if (p.y+p.dy+4)>(8*ty) then
     dy=0--(8*ty)-4-p.y
    end
   end
   if fget(tile,1) then
    if (p.y+p.dy-4)<(8*ty) then
     dy=0--(8*ty)+4-p.y
    end
   end
  end
  p.dy=dy
 end

 if abs(p.dy)<0.1 then p.dy=0 end
 if p.dy~=0 then
  printh("dy:"..p.dy)
  p.y=p.y+round(p.dy)
  end

end

function _draw()
 cls()
 map(0,0,0,0,16,16)
 spr(4,p.x,p.y)
 map(0,0,0,0,16,16,1)

 print(fget(tile,0) and 1 or 0,3,1,8)
 print(fget(tile,1) and 1 or 0,13,1,9)
 print(fget(tile,2) and 1 or 0,23,1,10)
 print(fget(tile,3) and 1 or 0,33,1,11)
 print(fget(tile,4) and 1 or 0,43,1,12)
 print(fget(tile,5) and 1 or 0,53,1,13)
 print(fget(tile,6) and 1 or 0,63,1,14)
 print(fget(tile,7) and 1 or 0,73,1,15)

 print(p.dx,0,50)
 print(p.dy,30,50)
end

__gfx__
000000006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000006666666622222222dddddddd888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020102020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030103030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030203030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030303030303030303030303030100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
