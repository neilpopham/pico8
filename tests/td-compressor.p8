pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- rle
-- by neil popham

function hex(v)
  local s,l,r=tostr(v,true),3,11
  while sub(s,l,l)=="0" do l+=1 end
  while sub(s,r,r)=="0" do r-=1 end
  return sub(s,min(l,6),flr(v)==v and 6 or max(r,8))
end

function lpad(x,n)
 n=n or 2
 return sub("0000000"..x,-n)
end

function compress()
 local room,row,previous,count={},{},nil,0
 local sprite
 for y=0,23 do
  row={}
  count=0
  previous=nil
  for x=0,23 do
   sprite=mget(x,y)-1
   printh("cell:"..x..","..y.." sprite:"..(sprite and sprite or "nil").." previous:"..(previous and previous or "nil").." count:"..count)
   if sprite==previous or previous==nil then
    count=count+1
   else
    add(row,shl(count,2)+previous)
    printh("block change, adding to row ("..shl(count,2).."+"..previous..")")
    count=1
   end
   previous=sprite
  end --x
  add(row,shl(count,2)+previous)
  printh("end of row, adding to row, adding row to room ("..shl(count,2).."+"..previous..")")
  add(room,row)
 end --y
 return room
end

function decompress()
 local collection,room,row={},{},{}
 local mx,my,x,y,r=0,0,1,1,1
 local s=mget(mx,my)
 while s>0 do
  local t=band(s,3)
  local c=shr(s-t,2)
  for i=1,c do
   row[x]=t
   x=x+1
  end
  if x>24 then
   room[y]=row
   x=1
   y=y+1
   row={}
   if y>24 then
    add(collection,room)
    x=1
    y=1
    room={}
   end
  end
  mx=mx+1
  if mx>127 then
   mx=0
   my=my+1
  end
  s=mget(mx,my)
 end
 return collection
end

function do_compress()
 local room=compress()
 local s=""
 for k,r in pairs(room) do
  for _,b in pairs(r) do
   s=s..lpad(hex(b),2)
  end
 end
 printh(s)
 printh(s,"@clip")
end

function do_decompress()
 local c=decompress()
 for k,r in pairs(c) do
  printh("room "..k)
  for y=1,24 do
   local s=""
   for x=1,24 do
    s=s..r[y][x]
   end
   printh(s)
  end
 end
end

function _init()
 cls()
 printh("===")
 do_compress()
 --do_decompress()
end

function _update60()
end

function _draw()
end

--##############################################################################################################################################################################################################################################################
--__map__
--606060601c291c1c291c1c291c1c0d100d1c1c0d100d1c1c0d100d1c29100d1c29100d1c29100d1c380d1c380d1c1406200d1c0c06080a180d1c100f0a140d1c0c170a100d1c0406041706140d1c120f1c0d1c040a10060406100d1c100a200d1c2006140d1c606060601c291c1c291c1c291c1c0d100d1c1c0d100d1c1c0d10
--0d1c29100d1c29100d1c29100d1c380d1c380d1c1406200d1c0c06080a180d1c100f0a140d1c0c170a100d1c0406041706140d1c120f1c0d1c040a10060406100d1c100a200d1c2006140d1c

__map__
0101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020202020202020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020202020202020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020202020202020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020201010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101030101010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010301010303010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010104040403030101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010404040404030301010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103010404040404030101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030304040401010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103030101010103010301010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103030101010101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030101010101020202010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
