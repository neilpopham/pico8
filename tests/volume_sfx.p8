pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

-- https://www.lexaloffle.com/bbs/?tid=35559
-- https://www.lexaloffle.com/bbs/?tid=2341

--sfx is a 3 note triangle loop, so we only display and affect the first 3 notes
-- test for proximity to energy beam for adventure
-- 2,1,1 should be lowest, so may need mapping according to volume 1-7
-- if any volume reaches 0 the whole sound changes style
-- setting a min of 1 kinda works but 1,1,1 sounds wrong
-- if the volume is set to 0 in the cart we don't need to subtract then add, just add
    -- or if we reset the sfx in code to 0,0,0 on init and any time it stops

function _init()
    sfx(0)
    v=7
    map={0, 3, 2}
end

function _update()
    if (btnp(2)) v+=1
    if (btnp(3)) v-=1

    -- stop the sfx
    if (btnp(4)) sfx(0, -2)
    -- start
    if (btnp(5)) sfx(0)
    v=mid(0,v,7)
end

-- sets the volume of a single note in the given sfx
function set_volume(sfxid, note, value)
    -- find the address to peek
    local address=0x3200+68*sfxid+value*2
    -- get the bytes
    local bytes=%address
    -- clear the the volume bits
    bytes=bytes&0xf1ff
    -- shift the volume bits
    value=mid(0,value,7)<<9
    -- use them as a bitmask
    bytes=bytes|value
    -- save the bytes
    poke2(address,bytes)
end

-- sets the volume for a range of notes in the given sfx
function set_volumes(sfxid, start, values)
    -- find the address to peek
    local address=0x3200+68*sfxid+start*2
    -- loop through the values
    for _,value in ipairs(values) do
        -- get the bytes
        local bytes=%address
        -- clear the the volume bits
        bytes=bytes&0xf1ff
        -- shift the volume bits
        value=value<<9 
        -- use them as a bitmask
        bytes=bytes|value
        -- save the bytes
        poke2(address,bytes)
        -- move to the next note 
        address+=2       
    end
end

-- returns the volume of a note in the given sfx
function get_volume(sfxid, note)
    -- find the address to peek
    local address=0x3200+68*sfxid+note*2
    -- get the bytes
    local bytes=%address
    -- get the volume bits
    local value=0x0e00&bytes
    -- return the shifted volume bits 
    return value>>9
end

function _draw()
    cls()
    print(tostr(v), 0, 0, 7)
    print(tostr(v << 9), 8, 0, 7)
    -- set_volume(0, 0, mid(2, v, 7))
    -- set_volume(0, 1, mid(1, v-3, 7))
    -- set_volume(0, 2, mid(1, v-2, 7))

    set_volumes(0, 0, {mid(2, v, 7), mid(1, v-3, 7), mid(1, v-2, 7)})

    print(tostr(get_volume(0, 0)),0,20)
    print(tostr(get_volume(0, 1)),0,30)
    print(tostr(get_volume(0, 2)),0,40)
end

function _draw_old2()
    cls()
    print(tostr(v), 0, 0, 7)
    print(tostr(v << 9), 8, 0, 7)
    print("use ⬆️ ⬇️",64, 0, 2)

    local sfx_id=0
    -- can get fixed value 0x3200 == 12800
    local mem=0x3200+68*sfx_id

    for i=0,2 do
        local s=%mem -- s=peek2(mem)

        -- printh(i)
        -- printh(s)

        -- 0e00 = 0000 1110 0000 0000
        --        1111 11
        --        5432 1098 7654 3210
        -- bits 9-11 store volume
        --        1111 0001 1111 1111
        -- f1ff or 61951
        -- s & 0xf1ff will zero volume
        -- then s | (v << 9) will set volume

        local vr=0x0e00 & s
        local vol=(0x0e00 & s) >> 9
        -- local vol=0x0e00 & (s >> 9)     
        -- local vol=(0x0e00 >> 9) & s    
        print(tostr(vol), 0, 8+i*8, 8)
        print(tostr(vr), 8, 8+i*8, 8)

        poke2(mem,s-vr+((mid((i == 0 and 2 or 1), v-map[i+1], 7)) << 9))
        mem+=2
    end     
end

function _draw_old()
    -- chart sfx volume
    cls()
    print(tostr(v), 0, 0, 7)
    print(tostr(v << 9), 8, 0, 7)
    fillp(0x0f0f)
    rectfill(0,64,32,64-8,0x1)
    fillp()

    -- change to chart another sfx bank
    local sfx_id=0
    -- starting address
    local mem=0x3200+68*sfx_id

    for i=0,31 do
        -- read note
        local s=peek2(mem)
        -- bits 9-11 rebased to [0,7] range
        local vr=0x0e00 & s
        local vol=(0x0e00 & s) >> 9
        if i < 4 then
            print(tostr(vol), 0, 8+i*8, 8)
            print(tostr(vr), 8, 8+i*8, 8)
        end
        if i < 3 then
        -- change=mid(0, v-vol, 7)
            poke2(mem,s-vr+((mid(0, v-map[i+1], 7)) << 9))
        end
            -- print curve
        pset(i,64-vol,5+vol)
        mem+=2
    end
end 

__sfx__
000000030007702047010570076700767007670076700767007570076700777007770077700777007100072000730007400075000737007400073700720007270072700727007270072700727007270073700720
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002000001885000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
