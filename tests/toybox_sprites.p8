pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- px9 data compression v10
-- by zep & co.
--
-- changelog:
--
-- v11:
--  @felice: removed unneeded
--  brackets -> 214 tokens
--
-- v10:
--  @pancelor
--  ★ remove cruft
--  ★ clever getval() tricks
--  ★ fix low-entropy bug
--  215 tokens
--  @zep: added tests tab 3
--
-- v9:
--  @pancelor
--  ★ redo bitstream order
--  234 tokens (but ~4% slower)
--
-- v8:
--  @pancelor
--  ★ smaller vlist initialization
--  241 tokens
--
-- v7:
--  smaller vlist_val by @felice
--  7b -> 254 tokens (fastest)
--  7a -> 247 tokens (smallest)
--
-- v6:
--  smaller vlist_val by @p01
--  -> 258 tokens
--
-- v5:
--  fixed bug found by @icegoat
--  262 tokens (the bug was caused by otherwise redundant code!)
--
-- v4:
--  @catatafish
--  ★ smaller decomp
--
--  @felice
--  ★ fix bit flush at end
--  ★ use 0.2.0 functionality
--  ★ even smaller decomp
--  ★ some code simpler/cleaner
--  ★ hey look, a changelog!
--
-- v3:
--  @felice
--  ★ smaller decomp
--
-- v2:
--  @zep
--  ★ original release
--
--[[

    features:
    ★ 273 token decompress
    ★ handles any bit size data
    ★ no manual tuning required
    ★ decent compression ratios


    ██▒ how to use ▒██

    1. compress your data

        px9_comp(source_x, source_y,
            width, height,
            destination_memory_addr,
            read_function)

        e.g. to compress the whole
        spritesheet to the map:

        px9_comp(0,0,128,128,
            0x2000, sget)

    …………………………………
    2. decompress

        px9_decomp(dest_x, dest_y,
            source_memory_addr,
            read_function,
            write_function)

        e.g. to decompress from map
        memory space back to the
        screen:

        px9_decomp(0,0,0x2000,
            pget,pset)

        …………………………………

        (see example below)

        note: only the decompress
        code (tab 1) is needed in
        your release cart after
        storing compressed data.

]]

function old_init()
    -- test: compress from
    -- spritesheet to map, and
    -- then decomp back to screen

    cls()
    print("compressing..", 5)
    flip()

    w = 128
    h = 128
    raw_size = (w * h + 1) \ 2
    -- bytes

    ctime = stat(1)

    -- compress spritesheet to map
    -- area (0x2000) and save cart

    clen = px9_comp(
        0, 0,
        w, h,
        0x2000,
        sget
    )

    ctime = stat(1) - ctime

    --cstore() -- save to cart

    -- show compression stats
    print("                 " .. (ctime / 30) .. " seconds", 0, 0)
    print("")
    print("compressed spritesheet to map", 6)
    ratio = tostr(clen / raw_size * 100)
    print(
        "bytes: "
                .. clen .. " / " .. raw_size
                .. " (" .. sub(ratio, 1, 4) .. "%)",
        12
    )
    print("")
    print("press ❎ to decompress", 14)

    memcpy(0x7000, 0x2000, 0x1000)

    -- wait for user
    repeat
    until btn(❎)

    print("")
    print("decompressing..", 5)
    flip()

    -- save stats screen
    local cx, cy = cursor()
    local sdata = {}
    for a = 0x6000, 0x7ffc do
        sdata[a] = peek4(a)
    end

    dtime = stat(1)

    -- decompress data from map
    -- (0x2000) to screen

    px9_decomp(0, 0, 0x2000, pget, pset)

    dtime = stat(1) - dtime

    -- wait for user
    repeat
    until btn(❎)

    -- restore stats screen
    for a, v in pairs(sdata) do
        poke4(a, v)
    end

    -- add decompression stats
    print("                 " .. (dtime / 30) .. " seconds", cx, cy - 6, 5)
    print("")
end

-->8
-- px9 decompress

-- x0,y0 where to draw to
-- src   compressed data address
-- vget  read function (x,y)
-- vset  write function (x,y,v)

function px9_decomp(x0, y0, src, vget, vset)
    local function vlist_val(l, val)
        -- find position and move
        -- to head of the list

        --[ 2-3x faster than block below
        local v, i = l[1], 1
        while v != val do
            i += 1
            v, l[i] = l[i], v
        end
        l[1] = val
        --]]

        --[[ 7 tokens smaller than above
        for i,v in ipairs(l) do
            if v==val then
                add(l,deli(l,i),1)
                return
            end
        end
--]]
    end

    -- read an m-bit num from src
    local function getval(m)
        -- $src: 4 bytes at flr(src)
        -- >>src%1*8: sub-byte pos
        -- <<32-m: zero high bits
        -- >>>16-m: shift to int
        local res = $src >> src % 1 * 8 << 32 - m >>> 16 - m
        src += m >> 3
        --m/8
        return res
    end

    -- get number plus n
    local function gnp(n)
        local bits = 0
        repeat
            bits += 1
            local vv = getval(bits)
            n += vv
        until vv < (1 << bits) - 1
        return n
    end

    -- header

    local w_1, h_1, eb, el, pr, splen, predict =
        -- w-1,h-1
        gnp "0", gnp "0", gnp "1", {}, {}, 0
    --,nil

    for i = 1, gnp "1" do
        add(el, getval(eb))
    end
    for y = y0, y0 + h_1 do
        for x = x0, x0 + w_1 do
            splen -= 1

            if splen < 1 then
                splen, predict = gnp "1", not predict
            end

            local a = y > y0 and vget(x, y - 1) or 0

            -- create vlist if needed
            local l = pr[a] or { unpack(el) }
            pr[a] = l

            -- grab index from stream
            -- iff predicted, always 1

            local v = l[predict and 1 or gnp "2"]

            -- update predictions
            vlist_val(l, v)
            vlist_val(el, v)

            -- set
            vset(x, y, v)
        end
    end
end

-->8
-- px9 compress

-- x0,y0 where to read from
-- w,h   image width,height
-- dest  address to store
-- vget  read function (x,y)

function px9_comp(x0, y0, w, h, dest, vget)
    local dest0 = dest

    local function vlist_val(l, val)
        -- find position and move
        -- to head of the list

        --[ 2-3x faster than block below
        local v, i = l[1], 1
        while v != val do
            i += 1
            v, l[i] = l[i], v
        end
        l[1] = val
        return i
        --]]

        --[[ 8 tokens smaller than above
        for i,v in ipairs(l) do
            if v==val then
                add(l,deli(l,i),1)
                return i
            end
        end
--]]
    end

    local bit = 1
    local byte = 0
    local function putbit(bval)
        if (bval > 0) byte += bit
        poke(dest, byte)
        bit <<= 1
        if (bit == 256) then
            bit = 1 byte = 0
            dest += 1
        end
    end

    local function putval(val, bits)
        for i = 0, bits - 1 do
            putbit(val >> i & 1)
        end
    end

    local function putnum(val)
        local bits = 0
        repeat
            bits += 1
            local mx = (1 << bits) - 1
            local vv = min(val, mx)
            putval(vv, bits)
            val -= vv
        until vv < mx
    end

    -- first_used

    local el = {}
    local found = {}
    local highest = 0
    for y = y0, y0 + h - 1 do
        for x = x0, x0 + w - 1 do
            c = vget(x, y)
            if not found[c] then
                found[c] = true
                add(el, c)
                highest = max(highest, c)
            end
        end
    end

    -- header

    local bits = 1
    while highest >= 1 << bits do
        bits += 1
    end

    putnum(w - 1)
    putnum(h - 1)
    putnum(bits - 1)
    putnum(#el - 1)
    for i = 1, #el do
        putval(el[i], bits)
    end

    -- data

    local pr = {}
    -- predictions

    local dat = {}

    for y = y0, y0 + h - 1 do
        for x = x0, x0 + w - 1 do
            local v = vget(x, y)

            local a = y > y0 and vget(x, y - 1) or 0

            -- create vlist if needed
            local l = pr[a] or { unpack(el) }
            pr[a] = l

            -- add to vlist
            add(dat, vlist_val(l, v))

            -- and to running list
            vlist_val(el, v)
        end
    end

    -- write
    -- store bit-0 as runtime len
    -- start of each run

    local nopredict
    local pos = 1

    while pos <= #dat do
        -- count length
        local pos0 = pos

        if nopredict then
            while dat[pos] != 1 and pos <= #dat do
                pos += 1
            end
        else
            while dat[pos] == 1 and pos <= #dat do
                pos += 1
            end
        end

        local splen = pos - pos0
        putnum(splen - 1)

        if nopredict then
            -- values will all be >= 2
            while pos0 < pos do
                putnum(dat[pos0] - 2)
                pos0 += 1
            end
        end

        nopredict = not nopredict
    end

    if (bit > 0) dest += 1
    -- flush
    return dest - dest0
end

-->8
-- tests
-- uncomment run_tests() at
-- bottom of this tab. each
-- test compresses video and
-- checks crc matches.

--[[
expected sizes
blank:    21 (0.0026)
circ:    254 (0.0310)
lines:  2109 (0.2574)
dots:   2075 (0.2533)
lunch:  1275 (0.1556)
noise: 12819 (1.5648)
noise1: 3277 (0.4000)
]]

function vid_crc()
    local res = 109
    for i = 0x6000, 0x7fff, 4 do
        res ^^= 0x9e13.48b1
        res += $i
        res <<>= 5
        res *= 103.11
    end
    return res
end

-- compress whatever is on the
-- screen and check crc matches
function vid_test(name)
    crc0 = vid_crc()
    len = px9_comp(
        0, 0, 128, 128,
        0x8000, pget
    )
    printh(name .. ": " .. len
            .. " (" .. (len / 8192) .. ")")
    cls()
    px9_decomp(0, 0, 0x8000, pget, pset)

    crc1 = vid_crc()
    assert(crc0 == crc1)
end

function run_tests()
    printh("--- px9 tests ---")

    cls(2)
    vid_test("blank")

    -- circles
    cls()
    circfill(64, 64, 32, 12)
    vid_test("circ")

    --lines
    cls()
    for i = 0, 128, 4 do
        line(i, 0, 0, 128 - i, 8 + i / 8)
        line(i, 128, 128, 128 - i, 8 + i / 8)
    end
    vid_test("lines")

    --dots
    cls()
    srand()
    for i = 0, 2000 do
        circfill(rnd(128), rnd(128), rnd(16), rnd(16))
    end
    vid_test("dots")

    cls()
    spr(0, 0, 0, 16, 16)
    vid_test("lunch")

    -- noise
    cls()
    for i = 0x6000, 0x7fff do
        poke(i, rnd(256))
    end
    vid_test("noise")

    -- 1-bit noise
    cls()
    for i = 0x6000, 0x7fff do
        poke(i, rnd(2) + (rnd(2) \ 1) * 16)
    end
    vid_test("noise1")

    -- fuzz
    -- (would be more meaningful
    -- with more variation in
    -- data characteristics)
    srand()

    --for j=0,500 do
    for j = 0, 4 do
        cls(rnd(16))
        for i = 0, rnd(4000) do
            circfill(rnd(128), rnd(128), rnd(16), rnd(16))
        end
        for i = 0, rnd(4000) do
            pset(rnd(128), rnd(128), rnd(16), rnd(16))
        end
        vid_test("fuzz" .. j)
    end

    color(7)
    cls()
    stop("ok")
end

--run_tests()

-- reload(0x0, 0x0, 0x2000, "px9_2.p8")
clen = px9_comp(0, 0, 128, 128, 0x2000, sget)
cstore(0x0, 0x2000, clen, "toybox_sprites_compressed.p8")
stop()

__gfx__
00012000606660666066606660666066606660666066606616666661feeeeee87bbbbbb30000004000000030000300000b0dd030777777674f9f4fff7999a999
07d1257000000000000000000000000000000000007777006d6666d6e8888882b3333331040000000300000003000030d3000b0d76777777fffff9f49999979a
057d57d0666066606660566060333306608888066676d75062444426e8811882b33773310000040000000300000003b0000b030077777677ff4fffff99a99999
22566d11000000000000000000333300008888000077770064222246e8866882b3366531000400000003000000b00bb0b0030000777677779fff9ff999997997
11d6652206660666066605666033330660888806067d675664442446e8877282b3355131400000003000000030b30b003000dd0b677777774fffff9fa9999979
0d75d750000000000000000000331300008818000077770064222a96e8822182b33113310000000400000003003b00030b00000377777776ff4fffff999a9999
07521d70660666066606660660331306608818066605550664424446e8888882b33333310400000003000000030b00000300b00076777777ff9ff9ff99999799
0002100000000000000000000033330000888800000000006422224682222222311111110000400000003000000030000dd030b077776777f9ffff4f979999a9
111c111c7ccc7cc70000000005500550005070500500700000dddd00656565650d0aa000000aa000760000000766660006566650777777500007a90000000070
11c111c177ccc7cc000000000765676005076005000760050dddddd0666666650df99f000df99f0006500000766550000666666576666650000a0000000006d6
1c111c11c77ccc7c00000000076007605076660050766700dddddddd662226650de11e000de11e0700650000664500000659405676565650000aa90000006d60
c111c111cc77ccc7076007600765676050766605007676000555555066666665d55660070d66660200065006650450000009400076666650000a00000006d000
111c111c7cc77ccc07656760076007600766767007667670066666606655566509066602d5d6609200006560650045000009400076565650000a0000076d0000
11c111c1c7cc77cc0760076000000000576676655761166506dd6c6066111665000cc092090cc00200000650600004500009400076565650007aa9007dd6d000
1c111c11cc7cc77c1765676100000000766767667610016606dd6c606611166500c11c0200c11c000000604500000045000940000766650000a00a006d06d000
c111c111ccc7cc771d211d2100000000565655656610016606dd6660cc444ccc044004400440044000060004000000040009400000555000009aa900076d0000
0bb3b3b030bbb0030150051001500510940000499999999994000049000099997667060000065000d777777dd55550000076dc0000999900000000000007d000
bb3b3b350bbb3300157556511575515194544449444444444444444400094444641605000065d650566666657665d650075555d0094444900000000000766d00
b3b33333bb3bbb305757651557576515945555490550055004555550009440006666666065616560566666657661656001c6dc109444444900000000076666d0
b3333335b3b3b33505766650057656509400004904500450045004500944000011111156006176d011111155766176d007cc6d50999aa9990000000000044000
0b4334503bbb3b3505666650056565509400004904500450045004509945400076d176d57661110076d176d57661110007cc6d50955aa5590007d00000094000
0009450033b3b355575665155516551594544449045004500454445094405400656165606161d650656165607661d65007cc6d509544444900766d0000094000
0009450003335550156551511155515194555549444444444455554494000544d650d65064616560d650d6507661656007cc6d5095444449076666d000094000
095454540033350301500510015005109400004999999999940000499400004900000000766176d000000000d55176d00066d500999999990004400000094000
000990000777770000077000007dd500007665000554455000007000067666500007000099999999750705607776777677777776777777767777777677777776
049aa94075666660007667000007500007666650554444550000770000565100007a900090040405565656507665766576666665766666657766665576666665
49a99a940065d56000077000077665507666666545444454000076700067650007aaa90094444445057775007665766576555565766776657676656576666665
9a9aa9a900666660076666707766665576565565455a9554000077770067650007aaa90090004005767766606555655576566765767665657667566576666665
9a9aa9a900655d60765555677666666576666665411a911407007000006765000a99990094444445057665007677767776566765767665657667566576666665
49a99a94006666606500005676666665765565654445544476666667006765007556559095555555565656506576657676577765766556657676656576666665
049aa940006777775650056577666655766666654444444407666670006765000aaaa90000055000750605606576657676666665766666657766665576666665
00499400005555500567765007766550655555555444444500777700067666500000000005064005000000005565556565555555655555556555555565555555
00000000000005d9007a4200000000000000000900009999900a000000000000000000000049400000040000a7a9999900076000000000000001000000000000
0e82e82000555d5507a9942000000000000909aa009999aa09000a900009000009009090049a94000049400004a994400007610000111000001c10000eeeee20
e788888205d6d5550a999940000000000000aaaa09a9aaaa00009000008aa800008aa80049a7a940049a9400097999400007610001ccc10001c7c1007262626c
e88888825d7ddd500a99994000000009090a9a9a099a9909a000000000a77a9009a77a009a777a9449a7a94009a99990707765071c777c1001c7c10015252520
0888882056dddd500a9999400000a09a00a9a9a999a997900090000009a77a0000a77a9049a7a940049a9400099a99407667665601ccc10001c7c10002e50000
0088820055ddd5500ae999400000099a09aa9a7799a970000a000000008aa800008aa800049a940000494000009994007676656500111000001c10005e200000
000820000555550007fe9420000099a70aa9a7779aa090000900000000009000090900900049400000040000000a900007655651000000000001000025200000
0000000000555000007942000009aa779aaa97779aa90000000000000000000000000000000400000000000007a9994000766510000000000000000000000000
000550000005500005677650000550000567765000ddd0000000000000033000060aa05065656565757575751111111111111111111111112888888212888821
00566500005666000567765000566500567777650d666d0003333330033bb33006aa00505dddddd66060606015555555555555555555555188eeee88288ee882
0567765066677760567777650567765067766776d67666d033bbbb3333b77b3306a00a506d5555d5575757571565505050505050505556518ea77ae888eaae88
5677776577777776567777655675576577655677d66666d03b7777b33b7777b30600aa505d5cc6d6060606061555550505050505050555518e7777e88ea77ae8
6777777677777777677557765675576556500565dd666d503b7777b33b7777b3060aa0506d5cc6d5757575751555505050505050505555518e7777e88ea77ae8
77777777666775577777777705677650050000500dddd50033bbbb3333b77b3306aa00505d5666d6606060601555550505050505050555518ea77ae888eaae88
56666665005677505666666500566500000000000055500003333330033bb33006a00a506dddddd55757575715655050505050505055565188eeee88288ee882
05555550000566000555555000055000000000000000000000000000000330000600aa5055555555060606061555555555555555555555512888888212888821
00aaaa000007000000dddd0000dddd000022220050222205bb0bb0bb0b0bb0b00000bbb000000000000990003bb1000000666000000770000076660000766600
0a999940000e00000d7cc7d00d7cc7d0552882550528825003abba30b3abba3b000b1b1ba000bbb000007900b3b3b10006000600007755000712826007282160
a979979400e88000d71cc17dd77cc77d22588522225885220bbbbbb00bbbbbb00a0bbbbbb00b1b1b009a9990bb3bbb1060700060077665500612825006282150
a71991740e111800d77cc77dd71cc17d271881722718817203baab3003baab30b00b3707b00bbbbb0979a99913b3b3b160000060775555550066550000665500
a9999994e8191880dccccccddccccccd2888888228888882b003300b00033000b00bbb00b00b370799a999790bbb3bb160000060775e275507d75d6007d75d60
a992299408111820dcc11ccddcc11ccd28881882288188820b3bb3b00b3bb3b0bb0bbbb0bb0bb3309997aa9901b3b3b106000600775227557d7dd5d67d7dd5d6
b30880d5008882000dccccd00dceecd0028888299288882000bbbb00b0bbbb0b0bb0bbbbbbb0bbbb0999a990001bbb3000666000777776557d7dd5d57d7dd5d5
ff0ee0660008200000dddd0000dddd0099222290092222990bb33bb000b33b0000bbbbb00bbbbbb0009a99000001110b00000000055555500665565006655650
08000080a00700b00056650000077000004aa4000077770000777700000000076776d7765000000000d7cd0009aaaa900000567700a7777d0007700000077000
0000000007a00bba056766500076650044a77a4407666670000666700000007676675665650000000d77ccd09a1aa1a9000567760a6666dd0076670000700700
00880800077bba7b5676666500766500aa7777aa71166117a0776657000007667667566566500000d777cccd9a5aa5a905677775a7777d5d0766667007000070
8008e808b0b7aab067666666007665004aa77aa4712662177a6666660000766676675665666500007777cccc9aaaaaa95677775076666d5d7666666770000007
008ee80000ba7ab0666666660076650004a77a40066116606d666666000766667667566566665000dcccdddd09affa900567777676666d5d0005500000077000
000888000b7b77ab56666665007665004a7aa7a405666650d05661150076666676675665666665000dccddd09a9aa9a95677766576666d5d0006600000700700
000000800ab0b7aa05666650076666504aa44aa4006116000006665007666666766756656666665000dcdd00a900009a6777655076666dd00006600007000070
08008000ab0000a00056650006555550aa4004aa0056650000665000766666666552155666666665000dd0009a9009a9776650006ddddd000006600070000007
2002821000028210202000000006822d02822222020220d000000000000000000000000000000000007665000076650005555555555555555555555055677655
0211111122111111022282100026cdcd1111110002200d0000000000000000000000000000000000075006500750065055666666666666666666665556555565
11ddcdcd01ddcdcd001111110216ddddddcdcddd21ddd00002000000000000000000000000000000065006500650000056676767676767676767766556677665
006ddddd106ddddd66ddcdcd0016dddd66666d0081cddd0022ddd000000000000000000000000000766666657666666556777777777777777777776556677665
006d5ddd006d5ddd600ddddd0015ddd066dddd001ddddd008dddd000002282000202820002222200766166657663666556777676767676767676776555677655
0065111d0065111d0005ddd00052111056d111111c66d1111dddd1000221166600211110002282dd766166657663666556766676666666666767766556555565
00520010005200100552211100520010052200000d6661001d66611100666c10011dddd000111110766666657666666556776756666666667577666556677665
0502001005020010500200100502001000502000000552221d666222666dddc066666666666dddd0655555556555555556766665555555555667766556677665
0028210020000000002821002200000002228200005000000000000000000000c0c6cc0000777700056650000000000056677665555575555566765555555555
02111110222821000211111002282100221116660205002002022210202221000cccccc0071111605600650007a00a7056776665565755665555555556677665
d21ddcd60111111021ddcdcd0111111000666c10022560220022822102282210cdd7d7d071111115607006000a9009a056677665565757676565565655555555
d1dd66660ddddcd0666ddddd0dddcdc0066dddcd101d5682011111111111111006ddddd071100115600006000000000056776665575757777576755757777775
00d66d00066dddd06066dd00066dddd05555dd0011ddd62206ddcdcd0ddcdcd00d665ddd71100115560065000000000056677665575756766557675675555557
202211000066dd00001221000066dd00021dd00000dd661260d5dddd6d5dddd000c5ccc071111115056694500a90000056776665565756666565565655677655
02000010002212000110020000221100200100000dd6dc116552ddd16522dd11005c00c0061111500000094507a0000056677665565755665555555556776665
0000000100012000000000200002100000100000d000c1105220011152220001050c00c000555500000000940000000056776665555575555567665556677665
0028226000000000628210000022000022000000222200001112000006822d0026822d0077777777002820000077770056776675555755555677666556776665
002222600028220026111100081d0000820d0000228110001112800026cdcd0016cdcd0000000000028e8200076566d056676756665575656577666556677665
061221600022222006dcdc00621d0000612d000011dcd00011dc600016dddd0006dddd000600600608e7e8007665666d56777667676575657667766555776655
06d11dd0061221160ddddd00611c0200611c0200d66665d5dddd656506dddd0006dddd000000000008eee8007665556d56677777777575757777766575555557
0dd1d1d00dd11ddd05dddd006cdd52016cdd5201dddd0d00ddd6060005ddd00005ddd00000500500028e82007666666d56667676767575756767666557777775
005111000dd1d1dd522dd0d0d66d5211d6665211211100001112000005221110052211100000000000282000076666d056666666666575656666666555555555
0015000000551110220100000d6652100dd6521020001000100020005002000150020001010100100028200000dddd0055666666665575656666665556677665
00105000001051000110000000dd510000dd51002000010010000200500000005000000000000000002820000000000005555555555755555555555055555555
062281100000000000400000202821000028210000282100000000000000000000000000000000007777777711111100566666660015d0005666666500000000
6d6dcdc00000122240900040111111102111111021111110030100000606330000003300000000007555555717777610655115510015d0006666666600000000
506dddd0000dd18090a040900ddbdbd00ddbdbd01ddbdbd003013300663138300031383000077000756556571777610065155551001d50006000000601111110
506dddd0000ddd11a00090a40666dddd1666dddd0666dddd00313830633313300633133000766700755555571776610051155551000d15006000000605555550
5006ddd000ddddd10405a00900d5dd0000d5dd0000d5dd00003313303331301363313013005665007555555717667610655115110001d5006000000605555550
00021111002d6dd00905004a005111000052110000521100033130131110000011100000000550007565565716116761655551510001d0006000000605155150
000200010222166d0a5000900520001005002000052201001110000010000000100000000000000075555557010016716555515100105d006000000605111150
0002000020011006dd1110a05020000050010000500001001000000000000000000000000000000077777777000001105111111500150d000000000005111150
