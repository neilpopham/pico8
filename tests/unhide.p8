pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

printh('====')

function manhattan(x1,y1,x2,y2)
    return abs(x1-x2)+abs(y1-y2)
end

function tile(v) return v\8 end


local __hid__="3:2:9:6:1:14.11.13.11.14.11.13;11.12.11.12.13.12.13;13.11.12.11.11.11.12;11.12.11.13.14.13.13;14.11.14.13.11.13.04,6:9:6:13:0:11.12.11.14.14.11.13;13.13.12.11.12.13.12;11.12.14.11.11.12.11;11.11.14.12.11.14.11;04.13.11.11.12.11.13"

local original,visible,exiting,room={},false,false

local hidden={}

local rooms=split(__hid__)
for room in all(rooms) do
    local cells={}
    local ox,oy,tx,ty,dir,sprites=unpack(split(room,':'))
    local md=1
    for y,row in ipairs(split(sprites,';')) do
        local tmp={}
        for x,s in ipairs(split(row,'.')) do
            local d=manhattan(ox+x-1,oy+y-1,tx,ty)
            add(tmp,{sprite=s,d=d})
            md=max(md,d)
        end
        add(cells,tmp)
    end
    add(hidden,{ox=ox,oy=oy,tx=tx,ty=ty,dir=dir,t=0,md=md,cells=cells})
end

function get_hidden(x,y)
    for k,row in ipairs(hidden) do
        if x==row.tx and y==row.ty then
            room=row
            return
        end
    end
end

function check_room(tx,ty,dx)
    printh('room '..tostr(room))
    if room then
        printh('visible '..tostr(visible))
        if visible then
            if dx>0 then
                exiting=room.dir==1
            else
                exiting=room.dir==0
            end
        else
            show_room()
        end
    else
        get_hidden(tx,ty)
    end
    printh('exiting '..tostr(exiting))
end

function show_room()
    visible=true
    exiting=false
    room.t-=1
    room.showing=true
    room.hiding=false
    printh('SHOW ROOM')
end

function hide_room()
    visible=false
    exiting=true
    room.t+=1
    room.hiding=true
    room.showing=false
    printh('HIDE ROOM')
end

px=120
py=48

-- px=8
-- py=104

dx=0

function _update60()
    dx=0
    if btn(0) then dx=-1 end
    if btn(1) then dx=1 end

    -- dx*=0.1

    if dx!=0 then

        tx=flr((px+dx+(dx==1 and 7 or 0))/8)
        ty=flr(py/8)
        ti=mget(tx, ty)


        if fget(ti,1) and not visible then
            check_room(tx,ty,dx)
        elseif visible then
            tx=tile(px+dx+(dx>0 and 0 or 7))
            ti=mget(tx,ty)
            if fget(ti,1) then
                check_room(tx,ty,dx)
            elseif exiting then
                hide_room()
            end
        end
    end

    px+=dx

    if room then
        if room.showing then
            room.t+=1
            local hx,hy
            for y,row in ipairs(room.cells) do
                for x,tile in ipairs(row) do
                    hx,hy=room.ox+x-1,room.oy+y-1
                    if room.t==tile.d then
                        original[y..'|'..x]=mget(hx,hy)
                        mset(hx,hy,tile.sprite)
                    end
                end
            end
            if room.t==room.md then
                room.showing=false
            end
        end

        if room.hiding then
            room.t-=1
            for y,row in ipairs(room.cells) do
                for x,tile in ipairs(row) do
                    hx,hy=room.ox+x-1,room.oy+y-1
                    if room.t==tile.d then
                        mset(hx,hy,original[y..'|'..x])
                    end
                end
            end
            if room.t==0 then
                room.hiding=false
                room=nil
            end
        end
    end
end


function _draw()
    cls()
    map()

    -- tx=flr((px+(dx==1 and 7 or 0))/8)
    -- ty=flr(py/8)
    -- rect(tx*8,ty*8,tx*8+7,ty*8+7,3)

    spr(2,px,py)
    print()
end

__gfx__
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eee88eee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eee88eee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000011111111bbbbbbbb88888888eeeeeeee00000000000000000000000000000000000000000000000066666666eeeeeeeeffffffff7777777700000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666eeeeeeeeffffffff777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010101010100000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010101010100000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010101010100000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010101010100000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010101010300000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000101010101010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000101010101010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000101010101010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000101010101010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000301010101010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
