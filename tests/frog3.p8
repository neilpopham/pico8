pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

-- ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏èüÖæÔ∏è‚ùé

-- Using _ùò¶ùòØùò∑ in PICO-8
-- https://www.lexaloffle.com/bbs/?tid=49047
-- https://www.lexaloffle.com/bbs/?tid=38894


function mrnd(x,f)
    if f==nil then f=true end
    local r=x[1]+rnd((f and 1 or 0)+x[2]-x[1])
    return f and flr(r) or r
end

function range(n,m)
    return mrnd({n,m})
end

_G=_ENV

pixel={
    create=function(self,x,y,dir)
        local o=setmetatable(
            {
                x=x,
                y=y,
                dir=dir
            },
            self
        )
        self.__index=self
        return o
    end,
    fordir=function(_ENV,l,r)
        return dir==1 and r or l
    end,
    tile=function(p)
        return flr(p/8)
    end
} setmetatable(pixel,{__index=_ENV})

frog={
    create=function(self,x,y,dir)
        local o=pixel.create(self,x,y,dir)
        o.c=3
        o:reset()
        return o
    end,
    reset=function(_ENV)
        t=0
        stage=0
        r=range(12,16)
    end,
    update=function(_ENV)
        if stage==0 then return end
        local dx,dy,cx,cy,tx,ty,ti
        if stage==1 then
            dx=2*dir
            dy=-1
            if t==0 then sfx(0) end
        else
            dx=stage==2 and dir or 0
            dy=1
        end
        cx=x+(2*dir)
        cy=y+(stage==1 and -2 or 2)
        tx=tile(cx+dx)
        ty=tile(cy+dy)
        ti=mget(tx,ty)
        if fget(ti,0) then
            ti=mget(tile(cx),ty)
            if fget(ti,0) then
                if stage==1 then
                    y=ty*8+8
                else
                    y=ty*8-1
                    cy=y
                    reset(_ENV)
                end
            end
            ti=mget(tx,tile(cy))
            if fget(ti,0) then
                x=tx*8+(dir==1 and -3 or 10)
                if stage==1 and t<6 then dir=dir==1 and -1 or 1 end
            end
            if stage>0 then stage=3 end
            dx=0
            dy=0
        end
        x+=dx
        y+=dy
        x=x%128
        if stage==1 then
            t+=1
            if t==r then
                stage=2
            end
        end
    end,
    draw=function(_ENV)
        local ex=x+2*dir
        if stage==0 then
            line(x,y,x+1,y,c)
            pset(x+(dir==1 and 1 or 0),y-1,c)
        else
            line(x,y,ex,y+(stage==1 and -2 or 2),c)
        end
    end
} setmetatable(frog,{__index=pixel})

entities={}
for i=1,10 do
    add(entities,frog:create(rnd(100),rnd()>0.5 and 119 or 63,rnd()>0.5 and 1 or -1))
end

f=frog:create(0,63,1)

function _init()
    extcmd("rec")
end

function _update60()
    -- ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏èüÖæÔ∏è‚ùé

    if btn(‚¨ÖÔ∏è) then
        f.x-=1
        f.dir=-1
    end
    if btn(‚û°Ô∏è) then
        f.x+=1
        f.dir=1
    end
    if btnp(üÖæÔ∏è) and f.stage==0 then
        f.stage=1
    end
    if btnp(‚ùé) then
        f.dir=f.dir==1 and -1 or 1
    end

    -- if f.stage==0 then f.stage=1 end

    f:update()

    for _,e in pairs(entities) do
        e:update()
        if e.stage==0 then
            local r=rnd()
            if r>0.995 then
                e.stage=1
            end
        end
    end
end

function _draw()
    cls()
    map(0,0)
    f:draw()
    for _,e in pairs(entities) do
        -- e:draw()
    end
end

__gfx__
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000001000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000001010101000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010100010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0001000008140091600a1600b140147000200002000010001c0001d0001d000000000600023130201501e1501d120000000000000000020000000000000000000000000000042000320003200032000320003200
