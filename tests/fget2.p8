pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

local __tif__="13:2:3:1,2:2:1:1,2:6:2:1,5:2:1:2,5:6:2:2,5:6:2:4,2:6:2:1,5:6:2:2,8:2:1:4,8:6:2:4"
local _tif,_tiftiles={},split(__tif__)
for tile in all(_tiftiles) do
 local x,y,s,f=unpack(split(tile,":"))
 if not _tif[x] then _tif[x]={} end
 _tif[x][y]={s,f}
end

function tget(x,y,f)
 return f==nil and _tif[x][y][2] or _tif[x][y][2]&1<<f>0
end

function tgets(x,y)
 return _tif[x][y][1]
end

function tset(x,y,f,v)
 local _f=_tif[x][y][2]
 _f=v==nil and f or v and _f|1<<f or _f&~(1<<f)
 _tif[x][y][2]=_f
end


entities={}

function makebutton(x,y,f)
    mset(x\8,y\8,1)
    poke(0x4300+f,0)
end

function makedoor(x,y,f)
    local e={
        x=x,
        y=y,
        a=0x4300+f,
        update=function(self)
            self.s=peek(self.a)
        end,
        draw=function(self)
            if self.s==0 then spr(2,self.x,self.y) end
        end
    }
    add(entities,e)
end

function makeplayer(x,y,f)
    local e={
        x=x,
        y=y,
        update=function(self)
            if btn(➡️) then self.x+=1 end
            if btn(⬅️) then self.x-=1 end
            if btn(⬇️) then self.y+=1 end
            if btn(⬆️) then self.y-=1 end
            local tx,ty=(self.x+4)\8,(self.y+4)\8
            local tile=mget(tx,ty)
            if fget(tile,0) then
                poke(0x4300+tget(tx,ty),1)
            end
        end,
        draw=function(self)
            spr(3,self.x,self.y)
        end
    }
    add(entities,e)
end

-- call a maker function depending on the sprite index
local makers={
    [1]=makebutton,
    [2]=makedoor,
    [3]=makeplayer,
}

-- loop through all objects on the object layer and call a maker function
for x,col in pairs(_tif) do
    for y,t in pairs(col) do
        makers[t[1]](x*8,y*8,t[2])
    end
end

function _update60()
    for e in all(entities) do e:update() end
end


function _draw()
    cls()
    map()
    for e in all(entities) do e:draw() end
end


__gfx__
00000000888888887777777733333333111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000800000887000007730000033111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700800880087007700730033003111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000800000887007700730033003111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000800880087007700730000033111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700800880087007700730033333111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000800000887000007730033333111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888887777777733333333111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
