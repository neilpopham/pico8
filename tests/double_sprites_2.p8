pico-8 cartridge // http://www.pico-8.com
version 43
__lua__


-- px9 data compression v10
-- by zep & co.
--
-- changelog:
--
-- v11:
--  @felice: removed unneeded
--  brackets -> 214 tokens
--
-- v10:
--  @pancelor
--  ★ remove cruft
--  ★ clever getval() tricks
--  ★ fix low-entropy bug
--  215 tokens
--  @zep: added tests tab 3
--
-- v9:
--  @pancelor
--  ★ redo bitstream order
--  234 tokens (but ~4% slower)
--
-- v8:
--  @pancelor
--  ★ smaller vlist initialization
--  241 tokens
--
-- v7:
--  smaller vlist_val by @felice
--  7b -> 254 tokens (fastest)
--  7a -> 247 tokens (smallest)
--
-- v6:
--  smaller vlist_val by @p01
--  -> 258 tokens
--
-- v5:
--  fixed bug found by @icegoat
--  262 tokens (the bug was caused by otherwise redundant code!)
--
-- v4:
--  @catatafish
--  ★ smaller decomp
--
--  @felice
--  ★ fix bit flush at end
--  ★ use 0.2.0 functionality
--  ★ even smaller decomp
--  ★ some code simpler/cleaner
--  ★ hey look, a changelog!
--
-- v3:
--  @felice
--  ★ smaller decomp
--
-- v2:
--  @zep
--  ★ original release
--
--[[

    features:
    ★ 273 token decompress
    ★ handles any bit size data
    ★ no manual tuning required
    ★ decent compression ratios


    ██▒ how to use ▒██

    1. compress your data

        px9_comp(source_x, source_y,
            width, height,
            destination_memory_addr,
            read_function)

        e.g. to compress the whole
        spritesheet to the map:

        px9_comp(0,0,128,128,
            0x2000, sget)

    …………………………………
    2. decompress

        px9_decomp(dest_x, dest_y,
            source_memory_addr,
            read_function,
            write_function)

        e.g. to decompress from map
        memory space back to the
        screen:

        px9_decomp(0,0,0x2000,
            pget,pset)

        …………………………………

        (see example below)

        note: only the decompress
        code (tab 1) is needed in
        your release cart after
        storing compressed data.

]]

function old_init()

    -- test: compress from
    -- spritesheet to map, and
    -- then decomp back to screen

    cls()
    print("compressing..",5)
    flip()

    w=128 h=128
    raw_size=(w*h+1)\2 -- bytes

    ctime=stat(1)

    -- compress spritesheet to map
    -- area (0x2000) and save cart

    clen = px9_comp(
        0,0,
        w,h,
        0x2000,
        sget)

    ctime=stat(1)-ctime

    --cstore() -- save to cart

    -- show compression stats
    print("                 "..(ctime/30).." seconds",0,0)
    print("")
    print("compressed spritesheet to map",6)
    ratio=tostr(clen/raw_size*100)
    print("bytes: "
        ..clen.." / "..raw_size
        .." ("..sub(ratio,1,4).."%)"
        ,12)
    print("")
    print("press ❎ to decompress",14)

    memcpy(0x7000,0x2000,0x1000)

    -- wait for user
    repeat until btn(❎)

    print("")
    print("decompressing..",5)
    flip()

    -- save stats screen
    local cx,cy=cursor()
    local sdata={}
    for a=0x6000,0x7ffc do
        sdata[a]=peek4(a)
    end

    dtime=stat(1)

    -- decompress data from map
    -- (0x2000) to screen

    px9_decomp(0,0,0x2000,pget,pset)

    dtime=stat(1)-dtime

    -- wait for user
    repeat until btn(❎)

    -- restore stats screen
    for a,v in pairs(sdata) do
        poke4(a,v)
    end

    -- add decompression stats
    print("                 "..(dtime/30).." seconds",cx,cy-6,5)
    print("")

end

-->8
-- px9 decompress

-- x0,y0 where to draw to
-- src   compressed data address
-- vget  read function (x,y)
-- vset  write function (x,y,v)

function
    px9_decomp(x0,y0,src,vget,vset)

    local function vlist_val(l, val)
        -- find position and move
        -- to head of the list

--[ 2-3x faster than block below
        local v,i=l[1],1
        while v!=val do
            i+=1
            v,l[i]=l[i],v
        end
        l[1]=val
--]]

--[[ 7 tokens smaller than above
        for i,v in ipairs(l) do
            if v==val then
                add(l,deli(l,i),1)
                return
            end
        end
--]]
    end

    -- read an m-bit num from src
    local function getval(m)
        -- $src: 4 bytes at flr(src)
        -- >>src%1*8: sub-byte pos
        -- <<32-m: zero high bits
        -- >>>16-m: shift to int
        local res=$src >> src%1*8 << 32-m >>> 16-m
        src+=m>>3 --m/8
        return res
    end

    -- get number plus n
    local function gnp(n)
        local bits=0
        repeat
            bits+=1
            local vv=getval(bits)
            n+=vv
        until vv<(1<<bits)-1
        return n
    end

    -- header

    local
        w_1,h_1,      -- w-1,h-1
        eb,el,pr,
        splen,
        predict
        =
        gnp"0",gnp"0",
        gnp"1",{},{},
        0
        --,nil

    for i=1,gnp"1" do
        add(el,getval(eb))
    end
    for y=y0,y0+h_1 do
        for x=x0,x0+w_1 do
            splen-=1

            if splen<1 then
                splen,predict=gnp"1",not predict
            end

            local a=y>y0 and vget(x,y-1) or 0

            -- create vlist if needed
            local l=pr[a] or {unpack(el)}
            pr[a]=l

            -- grab index from stream
            -- iff predicted, always 1

            local v=l[predict and 1 or gnp"2"]

            -- update predictions
            vlist_val(l, v)
            vlist_val(el, v)

            -- set
            vset(x,y,v)
        end
    end
end

-->8
-- px9 compress

-- x0,y0 where to read from
-- w,h   image width,height
-- dest  address to store
-- vget  read function (x,y)

function
    px9_comp(x0,y0,w,h,dest,vget)

    local dest0=dest

    local function vlist_val(l, val)
        -- find position and move
        -- to head of the list

--[ 2-3x faster than block below
        local v,i=l[1],1
        while v!=val do
            i+=1
            v,l[i]=l[i],v
        end
        l[1]=val
        return i
--]]

--[[ 8 tokens smaller than above
        for i,v in ipairs(l) do
            if v==val then
                add(l,deli(l,i),1)
                return i
            end
        end
--]]
    end

    local bit=1
    local byte=0
    local function putbit(bval)
        if (bval>0) byte+=bit
        poke(dest, byte) bit<<=1
        if (bit==256) then
            bit=1 byte=0
            dest += 1
        end
    end

    local function putval(val, bits)
        for i=0,bits-1 do
            putbit(val>>i&1)
        end
    end

    local function putnum(val)
        local bits = 0
        repeat
            bits += 1
            local mx=(1<<bits)-1
            local vv=min(val,mx)
            putval(vv,bits)
            val -= vv
        until vv<mx
    end


    -- first_used

    local el={}
    local found={}
    local highest=0
    for y=y0,y0+h-1 do
        for x=x0,x0+w-1 do
            c=vget(x,y)
            if not found[c] then
                found[c]=true
                add(el,c)
                highest=max(highest,c)
            end
        end
    end

    -- header

    local bits=1
    while highest >= 1<<bits do
        bits+=1
    end

    putnum(w-1)
    putnum(h-1)
    putnum(bits-1)
    putnum(#el-1)
    for i=1,#el do
        putval(el[i],bits)
    end


    -- data

    local pr={} -- predictions

    local dat={}

    for y=y0,y0+h-1 do
        for x=x0,x0+w-1 do
            local v=vget(x,y)

            local a=y>y0 and vget(x,y-1) or 0

            -- create vlist if needed
            local l=pr[a] or {unpack(el)}
            pr[a]=l

            -- add to vlist
            add(dat,vlist_val(l,v))

            -- and to running list
            vlist_val(el, v)
        end
    end

    -- write
    -- store bit-0 as runtime len
    -- start of each run

    local nopredict
    local pos=1

    while pos <= #dat do
        -- count length
        local pos0=pos

        if nopredict then
            while dat[pos]!=1 and pos<=#dat do
                pos+=1
            end
        else
            while dat[pos]==1 and pos<=#dat do
                pos+=1
            end
        end

        local splen = pos-pos0
        putnum(splen-1)

        if nopredict then
            -- values will all be >= 2
            while pos0 < pos do
                putnum(dat[pos0]-2)
                pos0+=1
            end
        end

        nopredict=not nopredict
    end

    if(bit>0) dest+=1 -- flush

    return dest-dest0
end

-->8
-- tests
-- uncomment run_tests() at
-- bottom of this tab. each
-- test compresses video and
-- checks crc matches.

--[[
expected sizes
blank:    21 (0.0026)
circ:    254 (0.0310)
lines:  2109 (0.2574)
dots:   2075 (0.2533)
lunch:  1275 (0.1556)
noise: 12819 (1.5648)
noise1: 3277 (0.4000)
]]

function vid_crc()
    local res=109
    for i=0x6000,0x7fff,4 do
        res ^^= 0x9e13.48b1
        res += $i
        res <<>= 5
        res *= 103.11
    end
    return res
end

-- compress whatever is on the
-- screen and check crc matches
function vid_test(name)

crc0=vid_crc()
len=px9_comp(0,0,128,128,
    0x8000,pget)
printh(name..": "..len..
 " ("..(len/8192)..")")
cls()
px9_decomp(0,0,0x8000,pget,pset)

crc1=vid_crc()
assert(crc0==crc1)
end


function run_tests()

    printh("--- px9 tests ---")

    cls(2)
    vid_test("blank")

    -- circles
    cls()circfill(64,64,32,12)
    vid_test("circ")

    --lines
    cls()
    for i=0,128,4 do
    line(i,0,0,128-i,8+i/8)
    line(i,128,128,128-i,8+i/8)
    end
    vid_test("lines")

    --dots
    cls()srand()
    for i=0,2000 do
        circfill(rnd(128),rnd(128),rnd(16),rnd(16))
    end
    vid_test("dots")

    cls()spr(0,0,0,16,16)
    vid_test("lunch")

    -- noise
    cls()
    for i=0x6000,0x7fff do
        poke(i, rnd(256))
    end
    vid_test("noise")

    -- 1-bit noise
    cls()
    for i=0x6000,0x7fff do
        poke(i, rnd(2)+(rnd(2)\1)*16)
    end
    vid_test("noise1")

    -- fuzz
    -- (would be more meaningful
    -- with more variation in
    -- data characteristics)
    srand()

    --for j=0,500 do
    for j=0,4 do
    cls(rnd(16))
    for i=0,rnd(4000) do
        circfill(rnd(128),rnd(128),rnd(16),rnd(16))
    end
    for i=0,rnd(4000) do
        pset(rnd(128),rnd(128),rnd(16),rnd(16))
    end
    vid_test("fuzz"..j)
    end

    color(7)
    cls()
    stop("ok")

end


--run_tests()


-- reload(0x0, 0x0, 0x2000, "px9_2.p8")
clen = px9_comp(0, 0, 128, 128, 0x2000, sget)
cstore(0x0, 0x2000, clen, "double_sprites_2_compressed.p8")
stop()

__gfx__
00000000777777777777777777777777000000000000000000000000000000000000000077777777777777777777777700000000000000000000000000000000
00000000077777777777777777777777000000000000000000000000000000000000000007777777777777777777777700000000000000000000000000000000
00000000777777777777777777777777000000000000000000000000000000000000000077777777777777777777777700000000000000000000000000000000
00000000000000000000000000000000000777777777777700077777777777700000000000000000000000000000000000077777777777770007777777777770
00000000077777000000777007777770000700000000000000077777777777700000000007777700000077700777777000070000000000000007777777777770
00000000000000000007770000000000000707777777777700077000000000000000000000000000000777000000000000070777777777770007700000000000
00000000077077000077700077777777000707777777777700077000000000000000000007707700007770007777777700070777777777770007700000000000
00000000077000000777000000000000000707700000000000077000000000000000000007700000077700000000000000070770000000000007700000000000
77777700077077007777777700000000000707707000700000000000700000007777770007707700777777770000000000070770700070000000000070000000
77777770077000007777777700000000000707700707070700077000707770007777777007700000777777770000000000070770070707070007700070777000
00000000077077007777777700000000000707700070007000077000700070000000000007707700777777770000000000070770007000700007700070007000
77777700077000007777777700000000000707700707070700077000000070007777770007700000777777770000000000070770070707070007700000007000
77777770077077007777777700000000000707707000700000077000000070007777777007707700777777770000000000070770700070000007700000007000
00000000077000007777777700000000000707700707070700077000000070000000000007700000777777770000000000070770070707070007700000007000
77777700077077007777777700770777000707700070007000077000000070007777770007707700777777770077077700070770007000700007700000007000
77777770077000007777777700000770000707700707070700077000000070007777777007700000777777770000077000070770070707070007700000007000
00000000777077000000000007707700077777777777777777777777000070000000000077707700000000000770770007777777777777777777777700007000
70000000777000000000000007700000070000000000000070077777000070007000000077700000000000000770000007000000000000007007777700007000
70777777777077000000000007707700070000000007000070077777000070007077777777707700000000000770770007000000000700007007777700007000
70777777000000000000000007700000070777777777777777777777000070007077777700000000000000000770000007077777777777777777777700007000
70000000000000000000000007707700070000000000000077777777000070007000000000000000000000000770770007000000000000007777777700007000
70077770000000000000000000000000070000000000000077777777000070007007777000000000000000000000000007000000000000007777777700007000
00000000000000007777777777777777000000000000000077777777000070000000000000000000777777777777777700000000000000007777777700007000
00000000000000000000000000000000777000000000000077777777000070000000000000000000000000000000000077700000000000007777777700007000
77777777000000000000000000000000000770000007770000000000000000007777777700000000000000000000000000077000000777000000000000000000
00000000000000000000000000000000000770000077777000000000000000000000000000000000000000000000000000077000007777700000000000000000
07777770000000770000000000000000000770000777777700077700000000000777777000000077000000000000000000077000077777770007770000000000
07777770000070770077007700777700000000000777777700777770000000770777777000007077007700770077770000000000077777770077777000000077
00000000000700770770077000777700000070000700000707777777077000000000000000070077077007700077770000007000070000070777777707700000
00000000007000770000000000000000000070770007770007777777070007700000000000700077000000000000000000007077000777000777777707000770
00000000070000770000000000077000000070770007770007000007000707000000000007000077000000000007700000007077000777000700000700070700
00000000700000770000000000000000000070770007770000077700000777000000000070000077000000000000000000007077000777000007770000077700
00777700000000000077700000000000000070000000000000000000000000000077770000000000007770000000000000007000000000000000000000000000
70700707777777770007000000007000077070700000000000000000000000007070070777777777000700000000700007707070000000000000000000000000
70700707000000000077700000077000077070700000000000000000000000007070070700000000007770000007700007707070000000000000000000000000
70777707777777770070700000070000077070700000000000770000000000077077770777777777007070000007000007707070000000000077000000000007
70777707777777770077700000000000000070700000070007700770000000007077770777777777007770000000000000007070000007000770077000000000
70700707000000000007000000007000007070700700700007077000000000777070070700000000000700000000700000707070070070000707700000000077
70700707777777770077700000077000007070700070700000777077000707777070070777777777007770000007700000707070007070000077707700070777
00777700000000000070700000070000007070700070707070000077000007770077770000000000007070000007000000707070007070707000007700000777
70777707770000007000000777777777007777007777777700777000007700007077770777000000700000077777777700777700777777770077700000770000
70777707770000007070000770777707770000777777777707770770077770777077770777000000707000077077770777000077777777770777077007777077
00777700000000007077000777777777000000007007770700000777077770770077770000000000707700077777777700000000700777070000077707777077
70777707770000007077700700000000000000000007000000770777007700707077770777000000707770070000000000000000000700000077077700770070
70777707770000007007770777000077000000000000070007777000000000077077770777000000700777077700007700000000000007000777700000000007
00777700000000007000770777000077000000000000000007777077700777000077770000000000700077077700007700000000000000000777707770077700
70777707770000007000070777000077000000000700000000770077770777707077770777000000700007077700007700000000070000000077007777077770
70777707770000007000000777000077000000000000000000000000770077007077770777000000700000077700007700000000000000000000000077007700
00000000000000007000000777777770000000000770770000000000000000000000000000000000700000077777777000000000077077000000000000000000
77707770000000007070000777777777007000000770000000000000070000007770777000000000707000077777777700700000077000000000000007000000
00000000000000007077000770077707070700000700700000000700077000000000000000000000707700077007770707070000070070000000070007700000
70777707000077007077700700000070007000000700000000000000007007707077770700007700707770070000007000700000070000000000000000700770
00000000000000000000000000070077000007700000000007700000000000770000000000000000000000000007007700000770000000000770000000000077
07770777000777777777777770077000000007700700000000000000000000000777077700077777777777777007700000000770070000000000000000000000
00000000000777777777777707007077000000000000000000077700000000000000000000077777777777770700707700000000000000000007770000000000
77077770000000000000000000000077000700000000000077700777000700007707777000000000000000000000007700070000000000007770077700070000
00077700000000000000000000000000000000000000000000000000000000000007770000000000000000000000000000000000000000000000000000000000
07700077000000000000000000000000000000000000000000000000000000000770007700000000000000000000000000000000000000000000000000000000
07077707000000000000000000000000000000000000000000000000000000000707770700000000000000000000000000000000000000000000000000000000
00077700000000000000000000000000000000000000000000000000000000000007770000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00707070000000000000000000000000000000000000000000000000000000000070707000000000000000000000000000000000000000000000000000000000
00007000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000
00007000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777000000000000000000000000000000000000000077777777777777777777777700000000000000000000000000000000
00000000077777777777777777777777000000000000000000000000000000000000000007777777777777777777777700000000000000000000000000000000
00000000777777777777777777777777000000000000000000000000000000000000000077777777777777777777777700000000000000000000000000000000
00000000000000000000000000000000000777777777777700077777777777700000000000000000000000000000000000077777777777770007777777777770
00000000077777000000777007777770000700000000000000077777777777700000000007777700000077700777777000070000000000000007777777777770
00000000000000000007770000000000000707777777777700077000000000000000000000000000000777000000000000070777777777770007700000000000
00000000077077000077700077777777000707777777777700077000000000000000000007707700007770007777777700070777777777770007700000000000
00000000077000000777000000000000000707700000000000077000000000000000000007700000077700000000000000070770000000000007700000000000
77777700077077007777777700000000000707707000700000000000700000007777770007707700777777770000000000070770700070000000000070000000
77777770077000007777777700000000000707700707070700077000707770007777777007700000777777770000000000070770070707070007700070777000
00000000077077007777777700000000000707700070007000077000700070000000000007707700777777770000000000070770007000700007700070007000
77777700077000007777777700000000000707700707070700077000000070007777770007700000777777770000000000070770070707070007700000007000
77777770077077007777777700000000000707707000700000077000000070007777777007707700777777770000000000070770700070000007700000007000
00000000077000007777777700000000000707700707070700077000000070000000000007700000777777770000000000070770070707070007700000007000
77777700077077007777777700770777000707700070007000077000000070007777770007707700777777770077077700070770007000700007700000007000
77777770077000007777777700000770000707700707070700077000000070007777777007700000777777770000077000070770070707070007700000007000
00000000777077000000000007707700077777777777777777777777000070000000000077707700000000000770770007777777777777777777777700007000
70000000777000000000000007700000070000000000000070077777000070007000000077700000000000000770000007000000000000007007777700007000
70777777777077000000000007707700070000000007000070077777000070007077777777707700000000000770770007000000000700007007777700007000
70777777000000000000000007700000070777777777777777777777000070007077777700000000000000000770000007077777777777777777777700007000
70000000000000000000000007707700070000000000000077777777000070007000000000000000000000000770770007000000000000007777777700007000
70077770000000000000000000000000070000000000000077777777000070007007777000000000000000000000000007000000000000007777777700007000
00000000000000007777777777777777000000000000000077777777000070000000000000000000777777777777777700000000000000007777777700007000
00000000000000000000000000000000777000000000000077777777000070000000000000000000000000000000000077700000000000007777777700007000
77777777000000000000000000000000000770000007770000000000000000007777777700000000000000000000000000077000000777000000000000000000
00000000000000000000000000000000000770000077777000000000000000000000000000000000000000000000000000077000007777700000000000000000
07777770000000770000000000000000000770000777777700077700000000000777777000000077000000000000000000077000077777770007770000000000
07777770000070770077007700777700000000000777777700777770000000770777777000007077007700770077770000000000077777770077777000000077
00000000000700770770077000777700000070000700000707777777077000000000000000070077077007700077770000007000070000070777777707700000
00000000007000770000000000000000000070770007770007777777070007700000000000700077000000000000000000007077000777000777777707000770
00000000070000770000000000077000000070770007770007000007000707000000000007000077000000000007700000007077000777000700000700070700
00000000700000770000000000000000000070770007770000077700000777000000000070000077000000000000000000007077000777000007770000077700
00777700000000000077700000000000000070000000000000000000000000000077770000000000007770000000000000007000000000000000000000000000
70700707777777770007000000007000077070700000000000000000000000007070070777777777000700000000700007707070000000000000000000000000
70700707000000000077700000077000077070700000000000000000000000007070070700000000007770000007700007707070000000000000000000000000
70777707777777770070700000070000077070700000000000770000000000077077770777777777007070000007000007707070000000000077000000000007
70777707777777770077700000000000000070700000070007700770000000007077770777777777007770000000000000007070000007000770077000000000
70700707000000000007000000007000007070700700700007077000000000777070070700000000000700000000700000707070070070000707700000000077
70700707777777770077700000077000007070700070700000777077000707777070070777777777007770000007700000707070007070000077707700070777
00777700000000000070700000070000007070700070707070000077000007770077770000000000007070000007000000707070007070707000007700000777
70777707770000007000000777777777007777007777777700777000007700007077770777000000700000077777777700777700777777770077700000770000
70777707770000007070000770777707770000777777777707770770077770777077770777000000707000077077770777000077777777770777077007777077
00777700000000007077000777777777000000007007770700000777077770770077770000000000707700077777777700000000700777070000077707777077
70777707770000007077700700000000000000000007000000770777007700707077770777000000707770070000000000000000000700000077077700770070
70777707770000007007770777000077000000000000070007777000000000077077770777000000700777077700007700000000000007000777700000000007
00777700000000007000770777000077000000000000000007777077700777000077770000000000700077077700007700000000000000000777707770077700
70777707770000007000070777000077000000000700000000770077770777707077770777000000700007077700007700000000070000000077007777077770
70777707770000007000000777000077000000000000000000000000770077007077770777000000700000077700007700000000000000000000000077007700
00000000000000007000000777777770000000000770770000000000000000000000000000000000700000077777777000000000077077000000000000000000
77707770000000007070000777777777007000000770000000000000070000007770777000000000707000077777777700700000077000000000000007000000
00000000000000007077000770077707070700000700700000000700077000000000000000000000707700077007770707070000070070000000070007700000
70777707000077007077700700000070007000000700000000000000007007707077770700007700707770070000007000700000070000000000000000700770
00000000000000000000000000070077000007700000000007700000000000770000000000000000000000000007007700000770000000000770000000000077
07770777000777777777777770077000000007700700000000000000000000000777077700077777777777777007700000000770070000000000000000000000
00000000000777777777777707007077000000000000000000077700000000000000000000077777777777770700707700000000000000000007770000000000
77077770000000000000000000000077000700000000000077700777000700007707777000000000000000000000007700070000000000007770077700070000
00077700000000000000000000000000000000000000000000000000000000000007770000000000000000000000000000000000000000000000000000000000
07700077000000000000000000000000000000000000000000000000000000000770007700000000000000000000000000000000000000000000000000000000
07077707000000000000000000000000000000000000000000000000000000000707770700000000000000000000000000000000000000000000000000000000
00077700000000000000000000000000000000000000000000000000000000000007770000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00707070000000000000000000000000000000000000000000000000000000000070707000000000000000000000000000000000000000000000000000000000
00007000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000
00007000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000
